<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='28' fill='%23ff6a00'/><text x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Orbitron,sans-serif'>D</text></svg>"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DoubleShines Task Tracker</title>
    <link rel="stylesheet" href="./assets/tailwind.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --glow-color: #ff6a00;
        --item-height: 60px;
      }
      body {
        font-family: 'Poppins', sans-serif;
        background-color: #111827;
        color: #f3f4f6;
        /* Allow vertical scroll for the whole page; keep horizontal hidden to avoid confetti/animation scrollbars */
        overflow-x: hidden;
        overflow-y: auto;
      }
      .title-font {
        font-family: 'Orbitron', sans-serif;
      }
      .neon-glow {
        box-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color);
      }
      .neon-text {
        text-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color);
      }
      .ticker-viewport {
        height: calc(var(--item-height) * 5);
        width: 100%;
        overflow: hidden;
        position: relative;
        border-radius: 12px;
        border: 1px solid #374151;
        background-color: rgba(0, 0, 0, 0.1);
      }
      .ticker-reel {
        width: 100%;
        height: 100%;
        position: relative;
      }
      .ticker-item {
        height: var(--item-height);
        position: absolute;
        left: 0;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        padding: 0 20px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }
      .ticker-viewport::before,
      .ticker-viewport::after {
        content: '';
        position: absolute;
        left: 0;
        width: 100%;
        height: calc(var(--item-height) * 2);
        z-index: 2;
        pointer-events: none;
      }
      .ticker-viewport::before {
        top: 0;
        background: linear-gradient(to bottom, #111827, transparent);
      }
      .ticker-viewport::after {
        bottom: 0;
        background: linear-gradient(to top, #111827, transparent);
      }
      .pointer-line {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: var(--item-height);
        transform: translateY(-50%);
        border-top: 2px solid var(--glow-color);
        border-bottom: 2px solid var(--glow-color);
        box-shadow: 0 0 15px var(--glow-color);
        z-index: 1;
        opacity: 0.7;
      }
      .modal {
        transition: opacity 0.25s ease;
      }
      .modal-content {
        transition: transform 0.25s ease;
      }
      .task-item:hover .remove-btn {
        opacity: 1;
        transform: translateX(0);
      }
      .remove-btn {
        opacity: 0;
        transform: translateX(10px);
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }
      input[type='range'] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 10px;
        background: #374151;
        border-radius: 5px;
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      input[type='range']:hover {
        opacity: 1;
      }
      input[type='range']::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: var(--glow-color);
        border-radius: 50%;
        cursor: pointer;
      }
      input[type='range']::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: var(--glow-color);
        border-radius: 50%;
        cursor: pointer;
      }
      .transition-all-layout {
        transition: all 0.5s ease-in-out;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        filter: grayscale(50%);
      }
      nav,
      nav * {
        pointer-events: none !important;
      }
      #toggleManageBtn,
      #taskViewerBtn {
        pointer-events: auto !important;
      }

      .task-grid {
        display: grid;
        gap: 0.5rem;
        width: 100%;
        height: 100%;
      }
      .task-grid-item {
        background-color: #374151;
        border-radius: 8px;
        color: #f3f4f6;
        transition: background-color 0.3s ease, transform 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 4px;
        font-size: 12px;
        overflow: hidden;
        word-break: break-word;
      }
      .task-grid-item:hover {
        transform: scale(1.05);
        z-index: 10;
      }
      .task-grid-item.completed {
        background-color: #166534;
        color: #d1fae5;
      }

      .confetti-particle {
        position: fixed;
        top: 105vh;
        left: var(--x-start);
        pointer-events: none;
        font-size: var(--size);
        opacity: 0;
        animation: confetti-arc forwards;
        animation-duration: var(--duration);
        animation-timing-function: cubic-bezier(0.25, 1, 0.5, 1);
        animation-delay: var(--delay);
      }
      @keyframes confetti-arc {
        0% {
          transform: translateY(0) translateX(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(-120vh) translateX(var(--x-end)) rotate(720deg);
          opacity: 0;
        }
      }

      /* Styles for new viewer control buttons */
      .viewer-btn {
        padding: 0.5rem 1rem;
        background-color: #4b5563;
        color: white;
        transition: all 0.2s ease-in-out;
        border: 1px solid #374151;
        font-weight: 600;
      }
      .viewer-btn:hover {
        background-color: #374151;
      }
      .viewer-btn.active {
        background-color: var(--glow-color);
        color: #111827;
        box-shadow: 0 0 8px var(--glow-color);
        border-color: var(--glow-color);
        transform: scale(1.05);
      }
      #filterControls button:first-child,
      #sortControls button:first-child {
        border-top-left-radius: 0.5rem;
        border-bottom-left-radius: 0.5rem;
      }
      #filterControls button:last-child,
      #sortControls button:last-child {
        border-top-right-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-gray-900 flex flex-col items-center justify-center min-h-screen p-4 pt-24">
    <nav class="fixed top-0 left-0 w-full z-50">
      <div class="flex items-center justify-between p-2">
        <img src="DSSIT.png" alt="DoubleShines Logo" />
        <div class="flex space-x-2">
          <button
            id="taskViewerBtn"
            class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
          >
            Task Viewer
          </button>
          <button
            id="toggleManageBtn"
            class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
          >
            Manage Tasks
          </button>
        </div>
      </div>
    </nav>

    <div
      id="currentTaskContainer"
      class="w-full max-w-6xl mx-auto mb-8 p-6 rounded-2xl border border-gray-700 bg-gray-800/50 backdrop-blur-sm hidden"
    >
      <div class="text-center mb-4">
        <h2 id="taskStatusHeader" class="title-font text-2xl font-bold text-white">Current Task</h2>
        <p id="completionStats" class="text-xl font-semibold text-gray-200"></p>
      </div>
      <p
        id="currentTaskText"
        class="title-font text-4xl font-bold text-white neon-text text-center mb-6"
      ></p>
      <div id="currentTaskActions" class="flex justify-center space-x-4">
        <button
          id="currentTaskSkipBtn"
          class="bg-gray-600 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-700 transition-colors"
        >
          Skip
        </button>
        <button
          id="currentTaskCompleteBtn"
          class="bg-[var(--glow-color)] text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-opacity-80 transition-colors"
        >
          Completed
        </button>
      </div>
    </div>

    <div
      id="app-container"
      class="w-full max-w-[80vw] mx-auto flex flex-col lg:flex-row items-start justify-center gap-8 lg:gap-16 transition-all-layout"
    >
      <div
        id="spinnerContainer"
        class="flex flex-col items-center justify-center gap-6 w-full lg:w-full transition-all-layout"
      >
        <h1 class="title-font text-4xl md:text-5xl font-bold text-white neon-text text-center">
          DoubleShines Task Tracker
        </h1>
        <div class="ticker-viewport">
          <div class="pointer-line"></div>
          <div id="tickerReel" class="ticker-reel"></div>
        </div>
        <button
          id="spinBtn"
          class="title-font bg-gray-800 text-white font-bold py-4 px-10 rounded-full text-2xl border-2 border-[var(--glow-color)] transition-all duration-300 ease-in-out hover:bg-[var(--glow-color)] hover:text-gray-900 hover:scale-105 active:scale-95 neon-glow"
        >
          SPIN
        </button>
      </div>

      <div
        id="manageTasksPanel"
        class="w-full lg:w-1/3 bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl border border-gray-700 transition-all-layout hidden max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">Manage Tasks</h2>
        <div class="mb-4 p-3 rounded-lg border border-gray-700 bg-gray-900/60">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Roll Odds</h3>
            <div id="rollOddsInfo" class="text-right leading-5 text-sm"></div>
          </div>
        </div>
        <div class="flex mb-4">
          <input
            type="text"
            id="taskInput"
            placeholder="Enter a new task..."
            class="flex-grow bg-gray-900 border border-gray-600 rounded-l-lg p-3 focus:outline-none focus:ring-2 focus:ring-[var(--glow-color)] focus:border-transparent transition-all"
          />
          <button
            id="addTaskBtn"
            class="bg-[var(--glow-color)] text-gray-900 font-bold p-3 rounded-r-lg hover:bg-opacity-80 transition-colors"
          >
            +
          </button>
        </div>

        <input
          type="text"
          id="searchInput"
          placeholder="Search tasks..."
          class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-[var(--glow-color)] focus:border-transparent transition-all"
        />

        <div class="mb-4">
          <label for="spinDuration" class="block text-sm font-medium text-gray-300 mb-2"
            >Spin Duration: <span id="spinDurationValue">20</span> seconds</label
          >
          <input type="range" id="spinDuration" min="5" max="30" value="20" step="1" />
        </div>

        <div class="flex space-x-2 mb-4">
          <button
            id="shuffleBtn"
            class="w-1/2 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Shuffle
          </button>
          <button
            id="sortBtn"
            class="w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
          >
            Sort A-Z
          </button>
        </div>
        <div id="taskList" class="space-y-2 max-h-[350px] overflow-y-auto pr-2"></div>

        <h3 class="text-xl font-bold mt-6 mb-2 border-t border-gray-600 pt-4">Completed Tasks</h3>
        <div
          id="completedTaskList"
          class="space-y-2 max-h-[200px] overflow-y-auto pr-2 text-gray-400"
        ></div>

        <div class="mt-6 border-t border-gray-600 pt-4">
          <h3 class="text-xl font-bold mb-3">Danger Zone</h3>
          <button
            id="resetAllBtn"
            class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors mb-4"
            title="Reset all data and restore defaults"
          >
            Reset All (Are you sure?)
          </button>
        </div>
      </div>
    </div>

    <div
      id="winnerModal"
      class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none"
    >
      <div
        id="modalContent"
        class="modal-content bg-gray-800 rounded-2xl p-8 text-center border-2 border-[var(--glow-color)] neon-glow transform scale-95"
      >
        <h2 class="text-xl font-light text-white mb-2">The chosen task is...</h2>
        <p id="winnerText" class="title-font text-5xl font-bold text-white neon-text mb-8"></p>
        <div class="flex justify-center space-x-4">
          <button
            id="modalOkayBtn"
            class="bg-[var(--glow-color)] text-gray-900 font-bold py-2 px-6 rounded-full hover:bg-opacity-80 transition-colors"
          >
            Okay
          </button>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div
      id="resetConfirmModal"
      class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none"
    >
      <div
        class="modal-content bg-gray-800 rounded-2xl p-8 text-center border-2 border-red-500 transform scale-95"
      >
        <h2 class="text-2xl font-bold text-white mb-3">Reset all data?</h2>
        <p class="text-gray-300 mb-6">
          This will clear your current pool, current task, and completed list, and restore the
          starting defaults. This action cannot be undone.
        </p>
        <div class="flex justify-center gap-4">
          <button
            id="resetConfirmNoBtn"
            class="bg-gray-600 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-500 transition-colors"
          >
            Cancel
          </button>
          <button
            id="resetConfirmYesBtn"
            class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700 transition-colors"
          >
            Yes, Reset
          </button>
        </div>
      </div>
    </div>

    <div
      id="taskViewerModal"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] opacity-0 pointer-events-none transition-opacity duration-300"
    >
      <div
        class="bg-gray-900/80 backdrop-blur-md w-[95vw] h-[95vh] rounded-2xl p-6 border border-gray-700 flex flex-col"
      >
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
          <h2 class="text-3xl font-bold title-font text-white neon-text">Task Completion Viewer</h2>
          <button
            id="closeViewerBtn"
            class="text-3xl text-gray-400 hover:text-white transition-colors"
          >
            &times;
          </button>
        </div>

        <div
          class="flex flex-wrap gap-4 items-center justify-center mb-4 p-2 bg-gray-800/50 rounded-lg flex-shrink-0"
        >
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-300">Filter:</span>
            <div id="filterControls" class="inline-flex rounded-md shadow-sm" role="group">
              <button type="button" data-filter="all" class="viewer-btn">All</button>
              <button type="button" data-filter="completed" class="viewer-btn">Completed</button>
              <button type="button" data-filter="incomplete" class="viewer-btn">Incomplete</button>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-300">Sort:</span>
            <div id="sortControls" class="inline-flex rounded-md shadow-sm" role="group">
              <button type="button" data-sort="az" class="viewer-btn">A-Z</button>
              <button type="button" data-sort="random" class="viewer-btn">Shuffle</button>
            </div>
          </div>
        </div>

        <div id="taskGrid" class="task-grid flex-grow min-h-0"></div>
      </div>
    </div>

    <footer
      style="
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        padding: 10px;
        background-color: rgba(17, 24, 39, 0.8);
        color: white;
        z-index: 100;
      "
    >
      <div class="w-full px-3 grid grid-cols-1 md:grid-cols-3 items-center gap-2 text-sm">
        <div class="text-left">
          <p>Made by Gecko | Version 1.9.3 pl | Â© 2025</p>
        </div>
        <div class="text-center">
          <p class="text-gray-200">
            If you enjoy this site, your support helps keep it alive and enables more tools in the
            future - Thank You! - Heres a link to buy me a coffee for my work. 
          </p>
        </div>
        <div class="text-right">
          <a
            href="https://www.buymeacoffee.com/themrgecko"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Buy me a coffee"
            class="inline-block bg-yellow-400 hover:bg-yellow-300 text-gray-900 font-semibold px-4 py-2 rounded shadow"
          >
            Buy me a coffee
          </a>
        </div>
      </div>
    </footer>

    <script>
      // --- Default Task Lists ---
      const defaultEasyTasks = [
        'Visit Dragontooth Island by boat.',
        'View the skillguide.',
        'Using either a Silver Sickle or the Ivandis Flail, grow some fungus in the swamp using Bloom.',
        'Use the Home Teleport spell to return to Lumbridge.',
        'Use the Bank on Jatizso or Neitiznot.',
        'Use the bank in the workshop at Fort Forinthry.',
        'Use the Bank in Lletya.',
        'Use the bank at the Mage Arena.',
        'Use any of the magic carpets in the desert.',
        'Use an ectophial to return to Port Phasmatys.',
        'Upgrade a piece of Death Skull or Deathwarden equipment to tier 20.',
        'Sit on the bench with Sir Tiffy Cashien in Falador Park.',
        'Teleport to Castle Wars with a Ring of Dueling.',
        'Talk to Hans and find out how old you are.',
        'Switch to the Lunar Spellbook at the astral altar.',
        'Surge under the spine on Anachronia.',
        'Surge a distance of one tile.',
        'Store the items required for an emote clue in a Treasure Trail hidey-hole.',
        'Steal from the Varrock tea stall.',
        'Steal from any stall.',
        'Steal from any stall 10 times.',
        'Squish 10 corrupted scarabs.',
        'Spin a Ball of Wool.',
        'Spin 5 bowstring.',
        'Smith any bronze item.',
        'Smith 10 of any metal weapon or armour piece.',
        'Smelt a steel bar in the furnace in Lumbridge.',
        'Smelt a bronze bar.',
        'Smelt 10 bronze bars.',
        'Siphon from a fire essling in the Runespan.',
        'Set sail for Anachronia.',
        'Sell an item to any store.',
        'Search the Grand Gold Chest in room 3 of Pyramid Plunder in Sophanem.',
        'Search the Grand Gold Chest in room 2 of Pyramid Plunder in Sophanem.',
        'Search the Grand Gold Chest in room 1 of Pyramid Plunder in Sophanem.',
        'Scatter some Ashes.',
        'Scatter 25 ashes of any kind.',
        'Run out of Prayer points.',
        'Return a free item to any store.',
        'Restore your prayer using the altar in Lletya.',
        'Restore 50 Prayer Points at an Altar at once.',
        'Reach total level 100.',
        'Reach total level 50.',
        'Reach level 20 in any skill.',
        'Reach level 10 in any skill.',
        'Reach level 5 in any skill.',
        'Reach combat level 10.',
        'Reach combat level 5.',
        'Reach a score of 10 using the strange switches in the Wilderness.',
        'Rake any farming patch.',
        'Prospect any rock.',
        'Progress through the Leagues tutorial to unlock your first relic.',
        "Pray to Bandos's remains.",
        'Plant seeds in any farming patch.',
        'Plant seeds in any farming patch 10 times.',
        'Pickpocket from a man or woman.',
        'Pickpocket from a man or woman 10 times.',
        'Pickpocket anyone 5 times.',
        'Pick wheat from a field.',
        'Pick a pineapple on Karamja.',
        'Pick 5 Flax.',
        'Pass through the Holy barrier.',
        'Pan for an uncut jade at the Digsite.',
        'Open 30 Sedimentary Geodes.',
        'Offer 25 bones of any kind to an altar.',
        'Offer 5 bones of any kind to an altar.',
        'Obtain a Naragi engram from Orla Fairweather.',
        'Obtain 100 potent herbs from Herby Werby.',
        'Observe all the large dragonkin statues around Anachronia.',
        'Mine some iron ore in the mining spot south-west of Varrock.',
        'Mine some coal in the centre of Barbarian village.',
        'Mine iron ore from the mining site south-west of Lumbridge Swamp.',
        'Mine clay.',
        'Mine any ore 5 times.',
        'Mine a tin ore.',
        'Mine a gem rock at the Al Kharid mine.',
        'Mine a copper ore.',
        'Mine 10 tin ore.',
        'Mine 10 copper ore.',
        'Milk a cow.',
        'Make use of either an autoheater, gem bag, herbicide, bonecrusher or charming imp.',
        'Make some flour.',
        'Make some Bread.',
        'Make soft clay.',
        'Make an Attack Potion.',
        'Make a plank yourself on the sawmill in Fort Forinthry.',
        'Make a Pineapple Punch cocktail.',
        'Make a Necromancy Potion.',
        'Make 5 potions of any kind.',
        'Maintain nearly maximum stamina when mining for 60 seconds.',
        'Listen to any musician.',
        'Level up any of your skills for the first time.',
        'Let Brimstail teleport you to the Rune Essence mine.',
        'Learn how to raise your own animals at Manor Farm.',
        'Kill anything on the ground floor of the Slayer Tower.',
        'Kill an imp.',
        'Kill a snake.',
        'Kill a mugger near the Edgeville lodestone.',
        'Kill a goblin raider boss in the Goblin Village.',
        'Kill a goblin in Lumbridge.',
        'Kill a giant spider in Lumbridge or Lumbridge Swamp.',
        'Kill a giant rat in Lumbridge Swamp.',
        'Kill a dark wizard.',
        'Kill a crocodile.',
        'Kill a chicken.',
        'Jump over the Wilderness wall.',
        'Have Ned make you some rope from balls of wool.',
        'Have Elsie tell you a story.',
        'Have a tool leprechaun note any produce.',
        'Harvest any memory from a wisp 5 times.',
        "Harvest a rose at Het's Oasis.",
        'Harvest a memory from a pale wisp.',
        'Harvest a Grimy Marrentill.',
        'Harvest 10 memories from a pale wisp.',
        'Harvest 10 Grimy Tarromin.',
        'Hand Simon Templeton a pyramid top.',
        'Give Thurgo a redberry pie.',
        'Give Bill a beer in Fort Forinthry.',
        "Give a bone to one of Varrock's stray dogs (or to your pet stray dog if you have one).",
        "Get Harvey's ball back from the scary lady.",
        'Gate Spectre-ations',
        'Fletch some Arrow Shafts.',
        'Fletch an Oak Shortbow (unstrung).',
        'Fletch 50 Bronze bolts.',
        "Fill up Luthas' crate near the Musa Point plantation with bananas and receive 30 coins for your work.",
        'Fill a Charmed Sack with corruption at the Nexus in Lumbridge Swamp.',
        'Equip a Marksman hat.',
        'Equip a full set of Spider silk robes.',
        'Equip a full set of Iron armour without any upgrades.',
        'Equip a full set of Imphide robes.',
        'Equip a full set of Green Dragonhide armour.',
        'Enter the Wilderness from Ardougne.',
        'Enter the Earth Altar using an earth tiara or talisman.',
        'Enter the chaos tunnels from an entrance in the Wilderness.',
        'Enter the Brimhaven Dungeon.',
        'Enter Menaphos.',
        'Eat an onion.',
        'Eat a cabbage.',
        'Eat a baked potato.',
        'Drink a Strength Potion.',
        'Deposit an item with Peer the Seer.',
        'Defeat the Chaos Elemental.',
        'Defeat the Chaos Elemental.',
        'Defeat a Werewolf in Morytania.',
        'Defeat a Troll in the Fremennik Province.',
        'Defeat a Tortoise with riders in Kandarin.',
        'Defeat a Rock Crab in the Fremennik Province.',
        'Defeat a Greater Demon on Karamja.',
        'Defeat a Cockatrice in the Fremennik Province.',
        'Defeat a Black Unicorn in the Wilderness.',
        'Defeat 5 Feral Vampyres in the Haunted Woods.',
        'Dance in the Falador party room.',
        'Cross the spiky pit using the stepping stones within Brimhaven Dungeon.',
        'Create a spirit kalphite pouch at the obelisk south west of Pollnivneach.',
        'Create a Guthix Rest Potion.',
        'Craft some spirit or bone runes.',
        'Craft a water rune at the Water Altar.',
        'Craft a snelm.',
        'Cook some rat meat on a campfire in Lumbridge Swamp.',
        'Cook shrimp, meat, or chicken.',
        'Cook a Rabbit in Tirannwn.',
        'Cook 10 shrimp, meat, or chicken.',
        'Cook 5 fish.',
        'Convert at least one pale memory into energy.',
        'Conjure a zombie at the City of Um ritual site.',
        'Conjure a skeleton at the City of Um ritual site.',
        'Conjure a ghost at the City of Um ritual site.',
        'Complete You Are It.',
        'Complete The Blood Pact quest.',
        'Complete the Necromancy! quest.',
        'Complete the Helping Laniakea miniquest.',
        'Complete the Gnome Stronghold Agility Course.',
        'Complete the base camp tutorial.',
        'Complete the Archaeology tutorial.',
        'Complete Raksha, the Shadow Colossus quest.',
        'Complete an Easy Temple Trek.',
        'Complete an Easy clue scroll.',
        'Complete a task from Jacquelyn, the Lumbridge Slayer master.',
        'Complete a Lesser Necroplasm ritual.',
        'Complete a lap of the Burthorpe Agility course.',
        'Complete a Frozen floor in Daemonheim.',
        'Complete 10 laps of any Agility course.',
        'Complete 5 Slayer tasks.',
        'Collect 10 unique items for the General clue rewards collection log.',
        'Collect 5 seaweed from anywhere on Karamja.',
        "Climb to the top of the Wizards' Tower.",
        'Climb the Tower of Voices.',
        'Clean 15 Grimy Tarromin.',
        'Clean 10 of any herb',
        'Clean 5 of any herb.',
        'Clean 5 Grimy Guam.',
        'Claim a ticket from Brimhaven Agility Arena.',
        'Claim a free item from any store.',
        'Claim a free clue scroll from Zaida at the Grand Exchange.',
        'Chop any tree 5 times.',
        'Chop an oak tree.',
        'Chop a basic tree.',
        'Chop 10 basic trees.',
        'Charter a ship from Port Tyras.',
        'Catch some shrimp in the fishing spot to the east of Lumbridge Swamp.',
        'Catch any fish 5 times.',
        'Catch an anchovy.',
        'Catch a Wild Kebbit.',
        "Catch a whirligig at Het's Oasis.",
        'Catch a shrimp.',
        'Catch a Sapphire Glacialis.',
        'Catch a Karambwanji.',
        'Catch a herring.',
        'Catch a Crimson Swift in the Feldip Hills.',
        'Catch a Baby Impling.',
        'Catch 10 shrimp.',
        'Catch 10 Implings of any kind.',
        'Catch 5 Hunter creatures.',
        'Bury any bones.',
        'Bury any bones 10 times.',
        'Burn some logs using the everlasting bonfire in the Tower of Voices.',
        'Burn any logs.',
        'Burn any logs 5 times.',
        'Burn any food.',
        'Build a God statue in Taverley.',
        'Be assigned a Slayer task in Shilo Village.',
        'Attempt to pass a leaf trap.',
        'Add any compostable item to a compost bin.',
        'Activate the Wilderness lodestone.',
        'Activate the Tirannwn lodestone.',
        'Activate the thick skin, rock skin, or steel skin Prayer.',
        'Activate the Prifddinas lodestone.',
        'Activate the Canifis lodestone.',
        'Activate Superhuman or Ultimate Strength and Improved or Incredible Reflexes prayers at the same time.',
      ];
      const defaultMediumTasks = [
        'Win a Game of Castle Wars.',
        'Visit the Everlight dig site.',
        "Visit Mos Le'Harmless.",
        'Visit Harmony Island.',
        'Visit any Runecrafting altar through the Abyss.',
        'Use the Rune Goldberg Machine to create Vis wax.',
        'Use the range in Lumbridge Castle to bake a cake.',
        'Use the fairy ring in the Amlodd district.',
        'Use the Chivalry Prayer.',
        'Use an Elven Teleport Crystal.',
        'Upgrade a piece of Death Skull or Deathwarden equipment to tier 50.',
        'Unlock all of the Free to Play Lodestones.',
        'Travel to the Mammoth Iceberg.',
        'Teleport using Law runes.',
        'Take a medium companion through a medium route of Temple Trekking.',
        'Steal some Wine of Zamorak from the Captured Temple, south of Goblin Village.',
        'Steal from the lamp stall in Menaphos.',
        'Steal from the fish stall in Rellekka.',
        'Steal a lantern from a cave goblin.',
        'Smith 25 of any metal weapon or armour piece.',
        'Siphon Rune dust from a RuneSphere in the RuneSpan.',
        'Siphon from a nature esshound in the Runespan.',
        'Set up a dwarf cannon.',
        'Search the Grand Gold Chest in room 6 of Pyramid Plunder in Sophanem.',
        'Search the Grand Gold Chest in room 5 of Pyramid Plunder in Sophanem.',
        'Search the Grand Gold Chest in room 4 of Pyramid Plunder in Sophanem.',
        'Scatter 100 ashes of any kind.',
        'Sacrifice Dragon bones on the Chaos Altar.',
        'Ride a mine cart into Keldagrim.',
        'Restore a Pontifex signet ring.',
        'Restore 500 Prayer Points at an Altar at once.',
        "Repair the statue of Het at Het's Oasis.",
        'Reach world 25 in Shattered Worlds.',
        'Reach total level 500.',
        'Reach level 60 in any skill.',
        'Reach level 50 in any skill.',
        'Reach level 40 in any skill.',
        'Reach level 30 in any skill.',
        'Reach combat level 50.',
        'Reach at least level 30 in all non-elite skills.',
        'Reach at least level 20 in all non-elite skills.',
        'Reach at least level 10 in all non-elite skills.',
        'Reach at least level 5 in all non-elite skills.',
        'Purchase the herb bag and the herb bag upgrade from the Herby Werby reward shop.',
        'Plant seeds in any farming patch 100 times.',
        'Pickpocket anyone 200 times.',
        'Pickpocket a Varrock guard.',
        'Pickpocket a Knight of Ardougne 50 times.',
        'Pickpocket a H.A.M. member.',
        'Perform a Special Attack.',
        'Open the crystal chest in Taverley.',
        'Open 20 Igneous Geodes.',
        'Offer 100 bones of any kind to an altar.',
        'Obtain 50 Quest Points.',
        'Move Your House to Rellekka.',
        'Move your house to Prifddinas.',
        'Mine some orichalcite in the Mining Guild.',
        'Mine some Ore With a Rune Pickaxe.',
        'Mine any ore 200 times.',
        'Mine a ruby from a gem rock in Shilo Village.',
        'Mine a drakolith rock in the Tai Bwo Wannai mine.',
        'Mine 200 soft clay in Prifddinas.',
        'Mine 50 pure essence.',
        'Mine 40 Runite Ore.',
        'Mine 30 Adamant Ore.',
        'Mine 20 Mithril Ore.',
        'Medium Falador diary',
        'Medium desert tasks.',
        'Make one of each type of cocktail.',
        'Make a Stew.',
        'Make a Pineapple pizza.',
        'Make a Chocolate Cake.',
        'Make a batch of cannonballs in Port Phasmatys.',
        'Make a 4-dose Potion.',
        'Make 200 potions of any kind.',
        'Make 30 Prayer Potions.',
        'Make 20 Super Attack Potions.',
        'Light a Bullseye Lantern.',
        'Learn how to craft moonstone jewellery.',
        "Kill the lesser demon in the Wizards' Tower.",
        'Kill the Giant Mole.',
        'Kill the Giant Mole 100 times.',
        'Kill a metal dragon in Brimhaven Dungeon.',
        'Kill a blue dragon in Taverley dungeon.',
        'Kill 25 Yaks.',
        'Interact with a pet rock.',
        'Hunt a yellow wizard in the RuneSpan and give them some items.',
        'Hunt 10 Spotted Kebbits with the help of a falcon.',
        'Have either a Putrid Zombie or Vengeful Ghost conjured while fighting the matching creature.',
        'Harvest produce from 5 animals on Anachronia farm.',
        'Harvest bittercap mushrooms in the farming patch near Canifis.',
        'Harvest any memory from a wisp 200 times.',
        'Harvest a herb from the troll stronghold herb patch.',
        'Harvest 100 sparkling energy from Sparkling Wisps.',
        'Harvest 5 Grimy Ranarr.',
        'Complete the medium Varrock diary',
        'Complete the easy Varrock diary',
        'Complete the medium Lumbridge diary',
        'Complete the easy Lumbridge diary',
        'Complete the beginner Lumbridge diary',
        'Give Snoop some clean Dwarf weed.',
        'Get Stiles to exchange some of your fish for bank notes.',
        'Gather and convert 50 bright memories.',
        'Fully complete the Stronghold of Player Safety.',
        'Fletch 400 Steel arrows.',
        'Fletch 100 Iron bolts.',
        'Fletch 50 Maple shieldbow (unstrung).',
        'Fletch 50 Maple shieldbow (unstrung) in Kandarin.',
        'Fletch 1,000 Arrow Shafts.',
        'Finish a game of Werewolf Skullball.',
        "Equip Iban's staff.",
        'Equip any elemental battlestaff.',
        'Equip any 2 pieces of an Elegant outfit.',
        'Equip an Ogre Forester Hat.',
        'Equip an Obsidian cape.',
        'Equip an Iron Crossbow.',
        'Equip a Tzhaar-Ket-Om.',
        'Equip a Toktz-Xil-Ek.',
        'Equip a Toktz-Xil-Ak.',
        'Equip a Toktz-Ket-Xil.',
        'Equip a Spottier Cape.',
        'Equip a Saradomin, Zamorak, or Guthix cape.',
        'Equip a Salve Amulet (e).',
        'Equip a piece of Barrows armour.',
        'Equip a mystic staff.',
        'Equip a Maple shieldbow.',
        'Equip a Helm of Neitiznot.',
        'Equip a Granite Shield.',
        'Equip a full set of Steel armour.',
        'Equip a full set of Rune armour.',
        'Equip a full set of Red Dragonhide armour.',
        'Equip a full set of Mystic robes.',
        'Equip a full set of Mithril armour.',
        'Equip a full set of Graahk, Larupia or Kyatt hunter gear.',
        'Equip a full set of Blue Dragonhide armour.',
        'Equip a full set of Batwing robes.',
        'Equip a full set of Adamant armour.',
        'Equip a defender.',
        'Equip a composite bow of any kind.',
        'Equip a Barrows weapon.',
        "Enter the Wizards' Guild.",
        'Enter the Warriors Guild.',
        'Enter the Hardwood Grove in Tai Bwo Wannai.',
        'Enter the Fishing Guild.',
        'Enter the Crafting Guild.',
        "Enter the Cooks' Guild.",
        'Easy Falador diary',
        'Easy desert tasks.',
        'Earn a total of 10,000 beans from selling animals.',
        'Drink from the Tears of Guthix.',
        'Disgruntle an inhabitant of Um by wearing a bedsheet.',
        'Defeat the six Barrows Brothers and loot their chest.',
        'Defeat the six Barrows Brothers and loot their chest 100 times.',
        'Defeat the Rammernaut.',
        'Defeat the King Black Dragon.',
        'Defeat the King Black Dragon 100 times.',
        'Defeat the Kalphite Queen.',
        'Defeat the Kalphite Queen 100 times.',
        "Defeat Bossy McBossface's first mate.",
        'Defeat Bossy McBoss Face.',
        'Defeat any of the Dagannoth Kings 100 times.',
        'Defeat any of the Dagannoth Kings 1 time.',
        'Defeat a TzHaar.',
        'Defeat a Mithril Dragon.',
        'Defeat a Kurask in the Fremennik Province.',
        'Defeat a Jelly in the Fremennik Province.',
        'Defeat a Fire Giant in Kandarin.',
        'Defeat a Dagannoth in the Fremennik Province.',
        'Defeat 100 bosses in the Dominion Tower.',
        'Defeat 20 Bound Skeletons.',
        'Defeat 10 Fetid Zombies.',
        'Defeat 5 Green dragons.',
        'Cut a willow tree east of Lumbridge Castle.',
        'Create a Mithril Grapple.',
        'Craft some Combination runes.',
        'Craft 100 runes.',
        'Craft 50 Water Runes.',
        'Craft 50 Nature runes.',
        'Craft 50 Death Runes.',
        'Craft 50 cosmic runes.',
        'Craft 50 Astral Runes.',
        'Craft 1,000 runes.',
        'Cook 200 fish.',
        'Convert 100 gleaming memories in an energy rift.',
        'Conjure a Phantom Guardian at the City of Um ritual site.',
        'Complete Throne of Miscellania.',
        'Complete the New Foundations quest.',
        'Complete the Duck quest.',
        'Complete the Demon Slayer quest.',
        'Complete the Vampire Slayer quest.',
        'Complete One Piercing Note quest.',
        'Complete Smoking Kills quest.',
        'Complete Desert Treasure quest.',
        'Complete Dragin Slayer quest.',
        'Complete this miniquest.',
        'Complete the Penguin Agility Course.',
        'Complete the novice sections of the Anachronia agility course.',
        'Complete The Needle Skips.',
        'Complete the medium Wilderness Diary.',
        'Complete the medium Tirannwn Diary.',
        'Complete the medium Morytania Diary.',
        'Complete the medium Karamja Diary.',
        'Complete the Medium Fremennik Diary.',
        'Complete the medium City of Um Diary.',
        'Complete the Medium Ardougne Diary.',
        'Complete the easy Wilderness Diary.',
        'Complete the easy Tirannwn Diary.',
        'Complete the easy Morytania Diary.',
        'Complete the easy Karamja Diary.',
        'Complete the Easy Fremennik Diary.',
        'Complete the easy City of Um Diary.',
        'Complete the Easy Ardougne Diary.',
        'Complete the beginner sections of the Anachronia agility course.',
        'Complete the Barbarian Outpost Agility Course.',
        'Complete Royal Trouble.',
        'Complete Haunted Mine.',
        'Complete Elemental Workshop II.',
        'Complete a Medium clue scroll.',
        "Complete a lap of the Het's Oasis agility course.",
        'Complete a Hard clue scroll.',
        'Complete a communion ritual using a memento.',
        "Complete a ceremonial sword at the Artisans' Workshop.",
        'Complete 100 clues of any tier.',
        'Complete 75 Medium clue scrolls.',
        'Complete 75 Easy clue scrolls.',
        'Complete 25 Medium clue scrolls.',
        'Complete 25 laps of any Agility course.',
        'Complete 25 Hard clue scrolls.',
        'Complete 25 Easy clue scrolls.',
        'Complete 10 laps of the Wilderness agility course.',
        'Collect 25 unique items for the General clue rewards collection log.',
        'Collect 10 unique items for the Medium clue rewards collection log.',
        'Collect 10 unique items for the Easy clue rewards collection log.',
        'Collect 5 unique items for the Medium clue rewards collection log.',
        'Collect 5 unique items for the Hard clue rewards collection log.',
        'Collect 5 unique items for the Easy clue rewards collection log.',
        'Climb to the top of the lighthouse.',
        'Clear the Fort debris at the Kharid-et Dig Site.',
        'Clean 200 of any herb.',
        'Clean 50 Grimy Ranarr.',
        'Clean 50 Grimy Avantoe.',
        'Churn some butter.',
        'Chop any tree 200 times.',
        'Chop a willow tree.',
        'Chop 10 Arctic Pine trees.',
        'Check a grown Papaya Tree inside Tree Gnome Stronghold.',
        'Check a grown Papaya Tree in Lletya.',
        'Check a grown Fruit Tree.',
        'Check a grown banana tree on Karamja.',
        "Charge an Amulet of Glory in the Heroes' Guild.",
        'Catch any fish 200 times.',
        'Catch a Snowy Knight.',
        'Catch a salmon on Karamja.',
        'Catch a Red Salamander.',
        'Catch a Gourmet Impling.',
        'Catch a catfish.',
        'Catch 200 Hunter creatures.',
        'Catch 100 Lobsters.',
        'Catch 50 Swordfish.',
        'Catch 50 Salmon.',
        'Catch 35 Implings of any kind.',
        'Catch 25 lobsters on Karamja.',
        'Catch 25 Implings of any kind.',
        'Catch 20 implings in Puro-Puro.',
        'Catch 10 Pike.',
        'Catch 10 Pawyas in Isafdar.',
        'Catch 10 Green salamanders.',
        'Cast the Claws of Guthix special attack.',
        'Cast Moonclan Teleport.',
        'Buy some runes from Ali Morrisane.',
        'Bury some Baby Dragon bones.',
        'Bury 5 Dragon bones.',
        'Burn any logs 200 times.',
        'Burn 50 Maple logs.',
        'Burn 25 Willow logs.',
        'Build your Player Lodge on Anachronia.',
        "Browse through Oziach's Armour Shop.",
        'Activate Protect from Melee prayer.',
        'Activate and teleport from each of the Wilderness teleport obelisks.',
      ];
      const defaultHardTasks = [];
      const defaultMasterTasks = [];
      const defaultGrandMasterTasks = [];

      // DOM Elements
      const tickerReel = document.getElementById('tickerReel'),
        spinBtn = document.getElementById('spinBtn'),
        taskInput = document.getElementById('taskInput'),
        addTaskBtn = document.getElementById('addTaskBtn'),
        shuffleBtn = document.getElementById('shuffleBtn'),
        sortBtn = document.getElementById('sortBtn'),
        spinDurationSlider = document.getElementById('spinDuration'),
        spinDurationValue = document.getElementById('spinDurationValue'),
        taskList = document.getElementById('taskList'),
        winnerModal = document.getElementById('winnerModal'),
        modalContent = document.getElementById('modalContent'),
        winnerText = document.getElementById('winnerText'),
        modalOkayBtn = document.getElementById('modalOkayBtn'),
        toggleManageBtn = document.getElementById('toggleManageBtn'),
        manageTasksPanel = document.getElementById('manageTasksPanel'),
        spinnerContainer = document.getElementById('spinnerContainer'),
        appContainer = document.getElementById('app-container'),
        currentTaskContainer = document.getElementById('currentTaskContainer'),
        currentTaskText = document.getElementById('currentTaskText'),
        currentTaskSkipBtn = document.getElementById('currentTaskSkipBtn'),
        currentTaskCompleteBtn = document.getElementById('currentTaskCompleteBtn'),
        searchInput = document.getElementById('searchInput'),
        completedTaskList = document.getElementById('completedTaskList'),
        currentTaskActions = document.getElementById('currentTaskActions'),
        completionStats = document.getElementById('completionStats'),
        taskStatusHeader = document.getElementById('taskStatusHeader'),
        taskViewerBtn = document.getElementById('taskViewerBtn'),
        taskViewerModal = document.getElementById('taskViewerModal'),
        closeViewerBtn = document.getElementById('closeViewerBtn'),
        taskGrid = document.getElementById('taskGrid'),
        filterControls = document.getElementById('filterControls'),
        sortControls = document.getElementById('sortControls');

      // State variables
      let tasks = [],
        isSpinning = !1,
        lastWinner = null,
        audioContext = null,
        isSoundPlaying = !1,
        soundTimeoutId = null,
        taskViewerFilter = 'all',
        taskViewerSort = 'az';
      // Active default list for legacy fallbacks only (viewer uses all tiers; completion stats now use all tiers)
      let defaultTaskList = defaultEasyTasks;
      // Fixed target: start size equals easy list length. We maintain pool size at this target.
      let TARGET_POOL_SIZE = defaultEasyTasks.length;

      // Constants
      const ITEM_HEIGHT = 60,
        VISIBLE_ITEMS = 9,
        // Legacy keys (v1/v2) kept for migration
        TASKS_STORAGE_KEY_OLD = 'taskTickerTasks',
        TASKS_STORAGE_KEY = 'taskTickerTasks_v2',
        CURRENT_TASK_STORAGE_KEY_OLD = 'taskTickerCurrentTask_v2',
        // New keys (v3)
        TASKS_POOL_STORAGE_KEY = 'taskTickerPool_v1',
        CURRENT_TASK_STORAGE_KEY = 'taskTickerCurrentTask_v3',
        COMPLETED_STORAGE_KEY = 'taskTickerCompleted_v1';
      let virtualItems = [];

      // Quick lookups for defaults
      const easySet = new Set(defaultEasyTasks);
      const mediumSetConst = new Set(defaultMediumTasks);
      const hardSetConst = new Set(defaultHardTasks);
      const masterSetConst = new Set(defaultMasterTasks);
      const grandMasterSetConst = new Set(defaultGrandMasterTasks);

      const tierDefaults = {
        easy: defaultEasyTasks,
        medium: defaultMediumTasks,
        hard: defaultHardTasks,
        master: defaultMasterTasks,
        grandmaster: defaultGrandMasterTasks,
      };
      const tierSets = {
        easy: easySet,
        medium: mediumSetConst,
        hard: hardSetConst,
        master: masterSetConst,
        grandmaster: grandMasterSetConst,
      };
      const nextTierMap = {
        easy: 'medium',
        medium: 'hard',
        hard: 'master',
        master: 'grandmaster',
        grandmaster: null,
      };

      // Completed log (array of task texts); persisted
      let completedLog = [];
      function loadCompletedLog() {
        try {
          const raw = localStorage.getItem(COMPLETED_STORAGE_KEY);
          completedLog = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(completedLog)) completedLog = [];
        } catch (e) {
          completedLog = [];
        }
      }
      function saveCompletedLog() {
        try {
          localStorage.setItem(COMPLETED_STORAGE_KEY, JSON.stringify(completedLog));
        } catch (e) {}
      }
      function addCompleted(text) {
        completedLog.push(text);
        saveCompletedLog();
      }
      function removeOneCompleted(text) {
        const i = completedLog.indexOf(text);
        if (i > -1) {
          completedLog.splice(i, 1);
          saveCompletedLog();
        }
      }

      // --- Sound Synthesis Functions ---
      function getAudioContext() {
        return (
          audioContext || (audioContext = new (window.AudioContext || window.webkitAudioContext)()),
          audioContext
        );
      }
      function createTickSound(e, t) {
        const o = e.createOscillator(),
          n = e.createGain();
        o.connect(n),
          n.connect(e.destination),
          (o.type = 'sine'),
          o.frequency.setValueAtTime(440, t),
          n.gain.setValueAtTime(0.01, t),
          n.gain.linearRampToValueAtTime(0.3, t + 0.005),
          n.gain.linearRampToValueAtTime(1e-4, t + 0.05),
          o.start(t),
          o.stop(t + 0.05);
      }
      function createFlourishSound(e, t) {
        const o = e.createOscillator(),
          n = e.createGain();
        o.connect(n),
          n.connect(e.destination),
          (o.type = 'sine'),
          o.frequency.setValueAtTime(880, t),
          o.frequency.linearRampToValueAtTime(1760, t + 0.2),
          n.gain.setValueAtTime(0.01, t),
          n.gain.linearRampToValueAtTime(0.5, t + 0.01),
          n.gain.linearRampToValueAtTime(1e-4, t + 0.8),
          o.start(t),
          o.stop(t + 0.8);
      }
      function createShuffleSound() {
        const e = getAudioContext(),
          t = 0.3,
          o = e.currentTime,
          n = e.createOscillator(),
          i = e.createGain();
        n.connect(i),
          i.connect(e.destination),
          (n.type = 'sine'),
          n.frequency.setValueAtTime(1e3, o),
          n.frequency.linearRampToValueAtTime(100, o + t),
          i.gain.setValueAtTime(0.5, o),
          i.gain.linearRampToValueAtTime(1e-4, o + t),
          n.start(o),
          n.stop(o + t);
      }
      function startSpinSound() {
        if (isSoundPlaying) return;
        isSoundPlaying = !0;
        const e = getAudioContext();
        soundTimeoutId && clearTimeout(soundTimeoutId);
        const t = parseFloat(spinDurationSlider.value),
          o = Math.min(10 + 0.2 * tasks.length, 40),
          n = 1,
          i = e.currentTime + 0.1;
        let a = i,
          s = 0;
        const l = setInterval(() => {
          if (s >= t) {
            clearInterval(l);
            createFlourishSound(e, a);
            soundTimeoutId = setTimeout(() => {
              isSoundPlaying = !1;
              soundTimeoutId = null;
              if (audioContext && audioContext.state === 'running') {
                try {
                  audioContext.close();
                } catch (err) {}
                audioContext = null;
              }
            }, 1e3 * (a - e.currentTime + 1));
            return;
          }
          createTickSound(e, a);
          const d = s / t;
          let r = o - (o - n) * d;
          r = Math.max(r, n);
          const c = 1 / Math.max(r, 0.1);
          a += c;
          s += c;
          if (a > i + t + 0.5) {
            clearInterval(l);
            createFlourishSound(e, i + t);
            soundTimeoutId = setTimeout(() => {
              isSoundPlaying = !1;
              soundTimeoutId = null;
              if (audioContext && audioContext.state === 'running') {
                try {
                  audioContext.close();
                } catch (err) {}
                audioContext = null;
              }
            }, 1e3 * (i + t - e.currentTime + 1));
          }
        }, 10);
      }
      function createSuccessChime() {
        const e = getAudioContext(),
          t = e.currentTime,
          o = e.createGain();
        o.gain.setValueAtTime(0.3, t), o.gain.exponentialRampToValueAtTime(1e-4, t + 1.2);
        const n = e.createOscillator();
        (n.type = 'sine'),
          n.frequency.setValueAtTime(523.25, t),
          n.frequency.setValueAtTime(659.25, t + 0.1);
        const i = e.createOscillator();
        (i.type = 'sine'),
          i.frequency.setValueAtTime(783.99, t + 0.2),
          n.connect(o),
          i.connect(o),
          o.connect(e.destination),
          n.start(t),
          n.stop(t + 0.2),
          i.start(t + 0.2),
          i.stop(t + 1);
      }

      // --- Configurable Confetti Effect ---
      function launchConfetti() {
        // --- Easy-to-change variables ---
        const CONFETTI_COUNT = 80;
        const CONFETTI_SIZE = '3.5rem';
        const CONFETTI_DURATION_MIN = 5000; // milliseconds
        const CONFETTI_DURATION_MAX = 9000; // milliseconds
        // ------------------------------------

        const emojis = ['ð', 'ð¦', 'ð', 'ð', 'ð¦', 'â­'];
        for (let i = 0; i < CONFETTI_COUNT; i++) {
          const particle = document.createElement('div');
          particle.classList.add('confetti-particle');
          particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];

          const duration =
            Math.random() * (CONFETTI_DURATION_MAX - CONFETTI_DURATION_MIN) + CONFETTI_DURATION_MIN;

          particle.style.setProperty('--x-start', `${Math.random() * 100}vw`);
          particle.style.setProperty('--x-end', `${(Math.random() - 0.5) * 40}vw`);
          particle.style.setProperty('--size', CONFETTI_SIZE);
          particle.style.setProperty('--duration', `${duration}ms`);
          particle.style.setProperty('--delay', `${Math.random() * 0.5}s`);

          document.body.appendChild(particle);
          setTimeout(() => particle.remove(), duration + 500);
        }
      }

      // --- Core Application Logic ---
      const generateUniqueId = () => `_${Math.random().toString(36).substr(2, 9)}`;
      function shuffleTasks(e) {
        for (let t = e.length - 1; t > 0; t--) {
          const o = Math.floor(Math.random() * (t + 1));
          [e[t], e[o]] = [e[o], e[t]];
        }
      }
      function createVirtualItems() {
        (tickerReel.innerHTML = ''),
          (virtualItems = []),
          Array.from({ length: VISIBLE_ITEMS }).forEach(() => {
            const e = document.createElement('div');
            (e.className = 'ticker-item'), tickerReel.appendChild(e), virtualItems.push(e);
          });
      }
      function updateAndPositionItems(e) {
        if (0 === tasks.length) return void virtualItems.forEach((e) => (e.textContent = ''));
        const t = Math.round(e / ITEM_HEIGHT),
          o = Math.floor(VISIBLE_ITEMS / 2),
          n = t * ITEM_HEIGHT - e;
        virtualItems.forEach((i, a) => {
          const s = (t + a - o + 1e3 * tasks.length) % tasks.length,
            l = n + (a - o) * ITEM_HEIGHT + 2 * ITEM_HEIGHT;
          i.style.transform = `translateY(${l}px)`;
          const d = tasks[s]?.text || '';
          i.textContent !== d && (i.textContent = d);
        });
      }
      const easeOutCubic = (e) => --e * e * e + 1;
      function spin() {
        if (isSpinning || tasks.length < 1) return;
        (isSpinning = !0), (spinBtn.disabled = !0), startSpinSound();
        const e = Math.floor(Math.random() * tasks.length),
          t = tasks[e];
        if (!t) return (isSpinning = !1), void (spinBtn.disabled = !1);
        lastWinner = { id: t.id, text: t.text };
        const o = 15 + Math.floor(2 * Math.random()),
          n = o * tasks.length + e,
          i = n * ITEM_HEIGHT,
          a = 1e3 * parseFloat(spinDurationSlider.value);
        let s = null;
        const l = (d) => {
          s || (s = d);
          const r = Math.min((d - s) / a, 1),
            c = easeOutCubic(r),
            m = c * i;
          updateAndPositionItems(m),
            r < 1
              ? requestAnimationFrame(l)
              : ((isSpinning = !1), updateAndPositionItems(i), showWinnerModal(lastWinner.text));
        };
        requestAnimationFrame(l);
      }

      // --- Data & State Management ---

      // No settings: behavior is fully automatic.

      function loadData() {
        try {
          // Prefer new pool storage
          const poolRaw = localStorage.getItem(TASKS_POOL_STORAGE_KEY);
          const legacyRaw = localStorage.getItem(TASKS_STORAGE_KEY);
          const legacyRawV1 = localStorage.getItem(TASKS_STORAGE_KEY_OLD);
          const currentRawV3 = localStorage.getItem(CURRENT_TASK_STORAGE_KEY);
          const currentRawV2 = localStorage.getItem(CURRENT_TASK_STORAGE_KEY_OLD);

          if (poolRaw) {
            const parsed = JSON.parse(poolRaw);
            // Expect objects with {id,text,tier}
            if (Array.isArray(parsed) && parsed.length && parsed[0] && parsed[0].text) {
              tasks = parsed.map((t) => ({
                id: t.id || generateUniqueId(),
                text: t.text,
                tier:
                  t.tier === 'grandmaster'
                    ? 'grandmaster'
                    : t.tier === 'master'
                    ? 'master'
                    : t.tier === 'hard'
                    ? 'hard'
                    : t.tier === 'medium'
                    ? 'medium'
                    : t.tier === 'easy'
                    ? 'easy'
                    : 'custom',
              }));
              // Recompute target from initial default easy size if pool seems empty
              TARGET_POOL_SIZE = defaultEasyTasks.length || tasks.length;
            } else {
              tasks = defaultEasyTasks.map((text) => ({
                id: generateUniqueId(),
                text,
                tier: 'easy',
              }));
              TARGET_POOL_SIZE = defaultEasyTasks.length;
            }
          } else {
            // Fresh start: build pool from EASY defaults
            tasks = defaultEasyTasks.map((text) => ({
              id: generateUniqueId(),
              text,
              tier: 'easy',
            }));
            TARGET_POOL_SIZE = defaultEasyTasks.length;
            // Try to append legacy user-added tasks as custom
            let legacy = null;
            if (legacyRaw) legacy = JSON.parse(legacyRaw);
            else if (legacyRawV1) legacy = JSON.parse(legacyRawV1);
            if (Array.isArray(legacy) && legacy.length) {
              if (typeof legacy[0] === 'string') {
                legacy.forEach((text) =>
                  tasks.push({ id: generateUniqueId(), text, tier: 'custom' })
                );
              } else if (legacy[0] && legacy[0].text) {
                legacy.forEach((o) =>
                  tasks.push({ id: generateUniqueId(), text: o.text, tier: 'custom' })
                );
              }
            }
          }

          // Restore current task (v3 preferred)
          const currentRaw = currentRawV3 || currentRawV2;
          (currentRaw && displayCurrentTask(JSON.parse(currentRaw))) || updateCompletionStats();
        } catch (e) {
          console.error('Error loading data:', e),
            (tasks = defaultTaskList.map((e) => ({
              id: generateUniqueId(),
              text: e,
              tier: 'easy',
            })));
        }
      }
      function saveTasksToLocalStorage() {
        try {
          localStorage.setItem(TASKS_POOL_STORAGE_KEY, JSON.stringify(tasks));
        } catch (e) {
          console.error('Error saving tasks:', e);
        }
      }
      function saveCurrentTask(e) {
        try {
          e
            ? localStorage.setItem(CURRENT_TASK_STORAGE_KEY, JSON.stringify(e))
            : localStorage.removeItem(CURRENT_TASK_STORAGE_KEY);
        } catch (e) {
          console.error('Error saving current task:', e);
        }
      }
      const createTaskFrequencyMap = (e) => e.reduce((e, t) => ((e[t] = (e[t] || 0) + 1), e), {});
      // Helper: detect tier for a given task text
      function getTierOfText(text) {
        if (grandMasterSetConst.has(text)) return 'grandmaster';
        if (masterSetConst.has(text)) return 'master';
        if (hardSetConst.has(text)) return 'hard';
        if (mediumSetConst.has(text)) return 'medium';
        if (easySet.has(text)) return 'easy';
        return 'custom';
      }
      // Return UNIQUE completed default tasks (across ALL tiers)
      function getCompletedDefaultTasks() {
        const isDefault = (t) =>
          easySet.has(t) ||
          mediumSetConst.has(t) ||
          hardSetConst.has(t) ||
          masterSetConst.has(t) ||
          grandMasterSetConst.has(t);
        const completedSet = new Set(completedLog.filter(isDefault));
        return Array.from(completedSet);
      }
      function updateCompletedListUI() {
        const uniqueCompleted = getCompletedDefaultTasks(); // texts across all tiers
        completedTaskList.innerHTML = '';
        if (uniqueCompleted.length === 0) {
          completedTaskList.innerHTML =
            '<p class="text-center italic">No tasks completed from the default list yet.</p>';
          return;
        }
        uniqueCompleted
          .map((text) => ({ text, tier: getTierOfText(text) }))
          .sort((a, b) => a.text.localeCompare(b.text))
          .forEach(({ text, tier }) => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between bg-gray-700/50 p-2 rounded-lg';
            const left = document.createElement('div');
            left.className = 'flex items-center gap-2 min-w-0';
            const badge = document.createElement('span');
            badge.className = 'text-xs px-2 py-0.5 rounded bg-gray-600 shrink-0';
            badge.textContent =
              tier === 'grandmaster'
                ? 'GM'
                : tier === 'master'
                ? 'Ma'
                : tier === 'hard'
                ? 'H'
                : tier === 'medium'
                ? 'M'
                : tier === 'easy'
                ? 'E'
                : 'C';
            const span = document.createElement('span');
            span.className = 'truncate pr-2';
            span.textContent = text;
            span.title = text;
            left.append(badge, span);
            const btn = document.createElement('button');
            btn.className =
              'text-xs bg-emerald-500 hover:bg-emerald-600 text-gray-900 font-bold px-3 py-1 rounded';
            btn.textContent = 'Restore';
            btn.title = 'Restore this task to active list';
            btn.addEventListener('click', () => restoreCompletedTask(text, tier));
            row.append(left, btn);
            completedTaskList.appendChild(row);
          });
      }

      function restoreCompletedTask(text, tier) {
        if (!text) return;
        const resolvedTier = tier || getTierOfText(text) || 'easy';
        tasks.push({ id: generateUniqueId(), text, tier: resolvedTier });
        // Remove one completion record for this task
        removeOneCompleted(text);
        // Keep pool size at target by removing a highest-tier item if oversized (prefer dropping above-easy)
        if (tasks.length > TARGET_POOL_SIZE) {
          const dropOrder = ['grandmaster', 'master', 'hard', 'medium'];
          for (const tier of dropOrder) {
            const idx = tasks.findIndex((t) => t.tier === tier);
            if (idx > -1) {
              tasks.splice(idx, 1);
              break;
            }
          }
        }
        updateTaskListUI();
        try {
          createShuffleSound();
        } catch {}
      }
      function updateCompletionStats() {
        // Count UNIQUE completed tasks across ALL default tiers
        const isDefault = (txt) =>
          easySet.has(txt) ||
          mediumSetConst.has(txt) ||
          hardSetConst.has(txt) ||
          masterSetConst.has(txt) ||
          grandMasterSetConst.has(txt);
        const filteredCompleted = completedLog.filter(isDefault);
        const completedUniqueAll = new Set(filteredCompleted).size;
        const totalDefaults =
          (defaultEasyTasks?.length || 0) +
          (defaultMediumTasks?.length || 0) +
          (defaultHardTasks?.length || 0) +
          (defaultMasterTasks?.length || 0) +
          (defaultGrandMasterTasks?.length || 0);
        const percent =
          totalDefaults > 0 ? ((completedUniqueAll * 100) / totalDefaults).toFixed(1) : 0;
        const nextIndex = filteredCompleted.length + 1;
        completionStats.textContent = `Task #${nextIndex} | ${percent}% Complete`;
      }
      function countPoolByTier() {
        let easy = 0,
          medium = 0,
          hard = 0,
          master = 0,
          grandmaster = 0,
          custom = 0;
        for (const t of tasks) {
          if (t.tier === 'easy') easy++;
          else if (t.tier === 'medium') medium++;
          else if (t.tier === 'hard') hard++;
          else if (t.tier === 'master') master++;
          else if (t.tier === 'grandmaster') grandmaster++;
          else custom++;
        }
        return { easy, medium, hard, master, grandmaster, custom, total: tasks.length };
      }
      function updateRollOddsUI() {
        const infoEl = document.getElementById('rollOddsInfo');
        if (!infoEl) return;
        const { easy, medium, hard, master, grandmaster, custom, total } = countPoolByTier();
        const easyCount = easy + custom; // custom is grouped with Easy odds
        const pct = (n) => (total ? ((n / total) * 100).toFixed(3) : '0.000');
        const rows = [
          { label: 'Easy', value: easyCount, color: 'text-emerald-300' },
          { label: 'Medium', value: medium, color: 'text-orange-300' },
          { label: 'Hard', value: hard, color: 'text-yellow-300' },
          { label: 'Master', value: master, color: 'text-purple-300' },
          { label: 'GrandâMaster', value: grandmaster, color: 'text-pink-300' },
        ];
        const listHtml = rows
          .map(
            (r) => `<div class="flex items-center justify-between">
              <span class="${r.color}">${r.label}</span>
              <span class="text-gray-200 font-semibold">${pct(r.value)}%</span>
            </div>`
          )
          .join('');
        infoEl.innerHTML = `<div class="space-y-1 text-sm">${listHtml}</div>`;
      }
      const updateTaskListUI = () => {
          const e = searchInput.value.toLowerCase(),
            t = tasks.filter((t) => t.text.toLowerCase().includes(e)),
            o = !!localStorage.getItem(CURRENT_TASK_STORAGE_KEY);
          (taskList.innerHTML = ''),
            0 === t.length
              ? (taskList.innerHTML = `<p class="text-gray-400 text-center">${
                  e ? 'No tasks match your search.' : 'Add tasks to spin!'
                }</p>`)
              : t.forEach((e) => {
                  const t = document.createElement('div');
                  (t.className =
                    'task-item flex items-center justify-between bg-gray-700 p-2 rounded-lg'),
                    (t.innerHTML = `<span class="flex-grow truncate pr-2">${
                      e.text
                    }</span><span class="text-xs px-2 py-0.5 rounded bg-gray-600 mr-2">${
                      e.tier === 'grandmaster'
                        ? 'GM'
                        : e.tier === 'master'
                        ? 'Ma'
                        : e.tier === 'hard'
                        ? 'H'
                        : e.tier === 'medium'
                        ? 'M'
                        : e.tier === 'easy'
                        ? 'E'
                        : 'C'
                    }</span><button title="Complete task" class="complete-btn text-emerald-400 hover:text-emerald-500 font-bold">â</button>`),
                    (t.querySelector('.complete-btn').onclick = () =>
                      completeTaskById(e.id, { playEffects: true })),
                    taskList.appendChild(t);
                }),
            (spinBtn.disabled = tasks.length < 1 || o),
            (shuffleBtn.disabled = o || tasks.length < 2),
            (sortBtn.disabled = o || tasks.length < 2),
            updateAndPositionItems(0),
            saveTasksToLocalStorage(),
            updateCompletedListUI(),
            updateCompletionStats(),
            updateRollOddsUI();
        },
        handleAddTask = () => {
          const e = taskInput.value.trim();
          e &&
            (tasks.push({ id: generateUniqueId(), text: e, tier: 'custom' }),
            (taskInput.value = ''),
            updateTaskListUI());
        };
      // Note: deletion from manage list replaced by completion tick

      // --- UI Interaction Handlers ---
      function showWinnerModal(e) {
        (winnerText.textContent = e || 'Nothing!'),
          winnerModal.classList.remove('opacity-0', 'pointer-events-none'),
          modalContent.classList.remove('scale-95');
      }
      function hideWinnerModal() {
        winnerModal.classList.add('opacity-0', 'pointer-events-none'),
          modalContent.classList.add('scale-95');
      }
      function handleModalOkay() {
        hideWinnerModal(), saveCurrentTask(lastWinner), displayCurrentTask(lastWinner);
      }
      function displayCurrentTask(e) {
        e &&
          (updateCompletionStats(),
          (taskStatusHeader.textContent = 'Current Task'),
          (currentTaskText.textContent = e.text),
          currentTaskActions.classList.remove('hidden'),
          currentTaskContainer.classList.remove('hidden'),
          (spinBtn.disabled = !0),
          (shuffleBtn.disabled = !0),
          (sortBtn.disabled = !0));
      }
      function showPostCompletionMessage() {
        (taskStatusHeader.textContent = 'Task Complete!'),
          (currentTaskText.textContent = 'Roll your next task'),
          currentTaskActions.classList.add('hidden'),
          currentTaskContainer.classList.remove('hidden');
        const e = !1;
        (spinBtn.disabled = tasks.length < 1 || e),
          (shuffleBtn.disabled = e || tasks.length < 2),
          (sortBtn.disabled = e || tasks.length < 2);
      }
      // Complete a task by its id, applying the same cascade and dump logic
      function completeTaskById(taskId, { playEffects = false } = {}) {
        if (!taskId) return;
        const poolTask = tasks.find((t) => t.id === taskId) || null;
        if (!poolTask) return;
        if (playEffects) {
          try {
            createSuccessChime();
          } catch {}
          try {
            launchConfetti();
          } catch {}
        }
        // Log completion if default
        if (
          easySet.has(poolTask.text) ||
          mediumSetConst.has(poolTask.text) ||
          hardSetConst.has(poolTask.text) ||
          masterSetConst.has(poolTask.text) ||
          grandMasterSetConst.has(poolTask.text)
        ) {
          addCompleted(poolTask.text);
        }
        // Remove from pool
        const idx = tasks.findIndex((t) => t.id === taskId);
        if (idx > -1) tasks.splice(idx, 1);
        // Replacement cascade: add one from next tier
        const next = nextTierMap[poolTask.tier];
        if (next) addRandomFromTier(next, 1);
        // Threshold-based dump and keep size
        checkAndMaybeDumpTiers();
        if (tasks.length < TARGET_POOL_SIZE) {
          const order = ['medium', 'hard', 'master', 'grandmaster'];
          for (const tier of order) {
            const needed = Math.max(0, TARGET_POOL_SIZE - tasks.length);
            if (needed <= 0) break;
            addRandomFromTier(tier, needed);
          }
        }
        // If current task matches this one, clear it
        try {
          const raw = localStorage.getItem(CURRENT_TASK_STORAGE_KEY);
          if (raw) {
            const cur = JSON.parse(raw);
            if (cur && cur.id === taskId) {
              saveCurrentTask(null);
            }
          }
        } catch {}
        updateTaskListUI();
      }
      function handleCompleteCurrentTask() {
        try {
          const raw = localStorage.getItem(CURRENT_TASK_STORAGE_KEY);
          if (raw) {
            const cur = JSON.parse(raw);
            completeTaskById(cur.id, { playEffects: true });
          }
        } catch {}
        saveCurrentTask(null), showPostCompletionMessage();
      }
      function handleSkipCurrentTask() {
        saveCurrentTask(null), showPostCompletionMessage();
      }
      function toggleManagePanel() {
        const e = manageTasksPanel.classList.contains('hidden');
        e
          ? (manageTasksPanel.classList.remove('hidden'),
            appContainer.classList.remove('justify-center'),
            appContainer.classList.add('lg:justify-between'),
            // when panel is visible, constrain overall width to original max
            appContainer.classList.remove('max-w-[80vw]'),
            appContainer.classList.add('max-w-6xl'),
            spinnerContainer.classList.remove('lg:w-full'),
            spinnerContainer.classList.add('lg:w-1/2'),
            updateRollOddsUI())
          : (manageTasksPanel.classList.add('hidden'),
            appContainer.classList.remove('lg:justify-between'),
            appContainer.classList.add('justify-center'),
            // when panel is hidden, allow spinner to grow to 80vw
            appContainer.classList.remove('max-w-6xl'),
            appContainer.classList.add('max-w-[80vw]'),
            spinnerContainer.classList.remove('lg:w-1/2'),
            spinnerContainer.classList.add('lg:w-full'));
      }

      function addRandomFromTier(tier, count) {
        if (!tier || count <= 0) return;
        const defaults = tierDefaults[tier] || [];
        const set = tierSets[tier];
        if (!defaults || defaults.length === 0) return;
        const inPool = new Set(tasks.filter((t) => t.tier === tier).map((t) => t.text));
        const completedForTier = new Set(completedLog.filter((t) => set && set.has(t)));
        const candidates = defaults.filter((t) => !inPool.has(t) && !completedForTier.has(t));
        if (candidates.length === 0) return;
        const toAdd = Math.min(count, candidates.length);
        for (let i = 0; i < toAdd; i++) {
          const idx = Math.floor(Math.random() * candidates.length);
          const text = candidates.splice(idx, 1)[0];
          tasks.push({ id: generateUniqueId(), text, tier });
        }
        updateTaskListUI();
      }

      // Dump all remaining tasks from a tier into the pool (excluding ones already in pool or completed)
      function dumpTierIntoPool(tier) {
        const defaults = tierDefaults[tier] || [];
        const set = tierSets[tier];
        if (!defaults || defaults.length === 0) return 0;
        const inPool = new Set(tasks.filter((t) => t.tier === tier).map((t) => t.text));
        const completedForTier = new Set(completedLog.filter((t) => set && set.has(t)));
        const candidates = defaults.filter((t) => !inPool.has(t) && !completedForTier.has(t));
        for (const text of candidates) {
          tasks.push({ id: generateUniqueId(), text, tier });
        }
        if (candidates.length) updateTaskListUI();
        return candidates.length;
      }

      // If remaining in a tier (by completions only) drops to 20% or less, dump next tier and expand target
      function checkAndMaybeDumpTiers() {
        const chain = ['easy', 'medium', 'hard', 'master'];
        for (const tier of chain) {
          const next = nextTierMap[tier];
          if (!next) continue;
          const totalDefaults = tierDefaults[tier]?.length || 0;
          if (totalDefaults === 0) continue;
          // Compute based ONLY on completed list (ignore in-pool and not-yet-pulled)
          const completedUniqueCount = new Set(
            completedLog.filter((t) => tierSets[tier] && tierSets[tier].has(t))
          ).size;
          const remainingByCompletion = totalDefaults - completedUniqueCount;
          const threshold = Math.ceil(totalDefaults * 0.2);
          if (remainingByCompletion <= threshold) {
            // Dump next tier fully and expand TARGET_POOL_SIZE to current tasks length
            dumpTierIntoPool(next);
            TARGET_POOL_SIZE = tasks.length;
          }
        }
      }

      // --- Task Viewer Functions ---
      function renderTaskViewerGrid() {
        const fullDefaultList = defaultEasyTasks
          .concat(defaultMediumTasks)
          .concat(defaultHardTasks)
          .concat(defaultMasterTasks)
          .concat(defaultGrandMasterTasks);
        const completedMap = createTaskFrequencyMap(completedLog);
        const used = {};

        let allTaskItems = fullDefaultList.map((taskText) => {
          const usedCount = used[taskText] || 0;
          const isCompleted = usedCount < (completedMap[taskText] || 0);
          if (isCompleted) used[taskText] = usedCount + 1;
          return { text: taskText, completed: isCompleted };
        });

        // Filter
        if (taskViewerFilter === 'completed') {
          allTaskItems = allTaskItems.filter((task) => task.completed);
        } else if (taskViewerFilter === 'incomplete') {
          allTaskItems = allTaskItems.filter((task) => !task.completed);
        }

        // Sort
        if (taskViewerSort === 'az') {
          allTaskItems.sort((a, b) => a.text.localeCompare(b.text));
        } else if (taskViewerSort === 'random') {
          shuffleTasks(allTaskItems);
        }

        const totalItems = allTaskItems.length;
        taskGrid.innerHTML = '';
        if (totalItems === 0) {
          taskGrid.innerHTML = `<p class="col-span-full text-center text-gray-400 text-2xl">No tasks match the current filter.</p>`;
          taskGrid.style.gridTemplateColumns = '1fr';
          taskGrid.style.gridTemplateRows = '1fr';
          return;
        }

        const containerWidth = taskGrid.clientWidth;
        const containerHeight = taskGrid.clientHeight;
        const aspectRatio = containerWidth / containerHeight;
        const idealCols = Math.sqrt(totalItems * aspectRatio);
        const cols = Math.ceil(idealCols);
        const rows = Math.ceil(totalItems / cols);

        taskGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        taskGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        const itemsToRender = allTaskItems.map((task) => {
          const div = document.createElement('div');
          div.className = `task-grid-item ${task.completed ? 'completed' : ''}`;
          div.textContent = task.text;
          return div;
        });
        taskGrid.append(...itemsToRender);
      }

      function updateViewerControlsUI() {
        document.querySelectorAll('#filterControls .viewer-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.filter === taskViewerFilter);
        });
        document.querySelectorAll('#sortControls .viewer-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.sort === taskViewerSort);
        });
      }

      function openTaskViewer() {
        updateViewerControlsUI();
        renderTaskViewerGrid();
        taskViewerModal.classList.remove('opacity-0', 'pointer-events-none');
      }
      function closeTaskViewer() {
        taskViewerModal.classList.add('opacity-0', 'pointer-events-none');
      }

      // --- Reset All ---
      function showResetModal() {
        const modal = document.getElementById('resetConfirmModal');
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-content').classList.remove('scale-95');
      }
      function hideResetModal() {
        const modal = document.getElementById('resetConfirmModal');
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.querySelector('.modal-content').classList.add('scale-95');
      }
      function performFullReset() {
        try {
          // Clear persisted data
          localStorage.removeItem(TASKS_POOL_STORAGE_KEY);
          localStorage.removeItem(CURRENT_TASK_STORAGE_KEY);
          localStorage.removeItem(TASKS_STORAGE_KEY);
          localStorage.removeItem(TASKS_STORAGE_KEY_OLD);
          localStorage.removeItem(CURRENT_TASK_STORAGE_KEY_OLD);
          localStorage.removeItem(COMPLETED_STORAGE_KEY);
        } catch {}

        // Reset in-memory state
        completedLog = [];
        tasks = defaultEasyTasks.map((text) => ({ id: generateUniqueId(), text, tier: 'easy' }));
        TARGET_POOL_SIZE = defaultEasyTasks.length;
        lastWinner = null;
        saveCurrentTask(null);
        saveTasksToLocalStorage();
        updateTaskListUI();
        updateViewerControlsUI();
        updateRollOddsUI();
      }

      // --- Event Listeners ---
      spinBtn.addEventListener('click', spin);
      addTaskBtn.addEventListener('click', handleAddTask);
      taskInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleAddTask();
      });
      shuffleBtn.addEventListener('click', () => {
        tasks.length > 1 && (shuffleTasks(tasks), updateTaskListUI(), createShuffleSound());
      });
      sortBtn.addEventListener('click', () => {
        tasks.length > 1 &&
          (tasks.sort((e, t) => e.text.localeCompare(t.text)),
          updateTaskListUI(),
          createShuffleSound());
      });
      spinDurationSlider.addEventListener('input', () => {
        spinDurationValue.textContent = spinDurationSlider.value;
      });
      modalOkayBtn.addEventListener('click', handleModalOkay);
      currentTaskCompleteBtn.addEventListener('click', handleCompleteCurrentTask);
      currentTaskSkipBtn.addEventListener('click', handleSkipCurrentTask);
      toggleManageBtn.addEventListener('click', toggleManagePanel);
      searchInput.addEventListener('input', updateTaskListUI);
      taskViewerBtn.addEventListener('click', openTaskViewer);
      closeViewerBtn.addEventListener('click', closeTaskViewer);
      taskViewerModal.addEventListener('click', (e) => {
        e.target === taskViewerModal && closeTaskViewer();
      });
      // Reset button and modal events
      const resetAllBtn = document.getElementById('resetAllBtn');
      const resetConfirmModal = document.getElementById('resetConfirmModal');
      const resetConfirmYesBtn = document.getElementById('resetConfirmYesBtn');
      const resetConfirmNoBtn = document.getElementById('resetConfirmNoBtn');
      if (resetAllBtn) {
        resetAllBtn.addEventListener('click', showResetModal);
      }
      if (resetConfirmNoBtn) {
        resetConfirmNoBtn.addEventListener('click', hideResetModal);
      }
      if (resetConfirmYesBtn) {
        resetConfirmYesBtn.addEventListener('click', () => {
          performFullReset();
          hideResetModal();
        });
      }
      // Close reset modal when clicking outside
      if (resetConfirmModal) {
        resetConfirmModal.addEventListener('click', (e) => {
          if (e.target === resetConfirmModal) hideResetModal();
        });
      }
      window.addEventListener('resize', () => {
        !taskViewerModal.classList.contains('opacity-0') && renderTaskViewerGrid();
      });

      // No settings to wire up anymore.

      filterControls.addEventListener('click', (e) => {
        if (e.target.matches('.viewer-btn')) {
          taskViewerFilter = e.target.dataset.filter;
          updateViewerControlsUI();
          renderTaskViewerGrid();
        }
      });

      sortControls.addEventListener('click', (e) => {
        if (e.target.matches('.viewer-btn')) {
          taskViewerSort = e.target.dataset.sort;
          updateViewerControlsUI();
          renderTaskViewerGrid();
        }
      });

      // --- Initialization ---
      window.onload = () => {
        loadCompletedLog();
        loadData();
        createVirtualItems();
        updateTaskListUI();
        updateViewerControlsUI(); // Set initial active buttons
        updateRollOddsUI();
      };
    </script>
  </body>
</html>
